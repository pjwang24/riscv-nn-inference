# ML Accelerator Improvements â€” 2026-02-18

Developed and verified Phase 2 of the Matmul Accelerator (4x4 Block Outer Product Engine).

## Findings & Bug Fixes

### 1. MMIO Register Map Alignment
*   **Issue**: The previous MMIO map had results starting immediately after dimension registers, risking overlap if definitions shifted.
*   **Fix**: Standardized the result base to `0x80000018`.
*   **Result**: Clean separation between configuration registers (`0x00-0x14`) and output registers (`0x18-0x54`).

### 2. Weight Packing Logic (`pack_weight_block`)
*   **Issue**: A copy-paste error used input buffer variables (`b0..b3`) instead of local weight variables (`w0..w3`).
*   **Fix**: Corrected variable names and enforced `uint8_t` casting before packing to avoid sign extension issues during bitwise OR.
*   **Improvement**: Enhanced row-major to interleaved packing to ensure 4 neurons are processed per inner loop iteration by the hardware.

### 3. Hardware-Software Addressing Consistency
*   **Issue**: Weight buffer offsets were calculated using the neuron index `i` rather than the block index `blk`. Since `i` advances by 4, this caused sparse/incorrect memory reads.
*   **Fix**: Updated to `blk * (K * 4)` offset logic.
*   **Verification**: Buffer sizes (100,352 bytes for FC1) now perfectly match the packing and DMA fetch pattern.

### 4. Dense Layer Accumulation (K Bug)
*   **Issue**: The accelerator was being told `K=4` for every call, regardless of the actual weights. This caused premature termination of the outer product loop.
*   **Fix**: Corrected `layer_dense_4x4` call to pass the actual hidden/input dimension `K`.

### 5. Bare-Metal Driver Stability
*   **Macro Safety**: Wrapped the `csr_tohost` assembly in `do { ... } while(0)` to prevent syntax errors in `if/else` blocks.
*   **Layer Constants**: Explicitly defined `INPUT_SIZE`, `HIDDEN_SIZE`, and `OUTPUT_SIZE` to match the `weights.h` shapes (784, 128, 10).

## Verification Milestone
*   **Simulation**: Successfully ran the 2-layer MLP inference on 100 images.
*   **Result**: `*** PASSED *** after 2000699 simulation cycles`.
*   **Performance**: Processed the test set in ~2M cycles with the 4x4 engine optimization.
