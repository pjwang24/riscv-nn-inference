# Improvement Log 2026-02-24

## Scope
This log records the transition from a single accelerator implementation to a dual path accelerator architecture with a preserved legacy path and a selectable systolic path.
The primary objective was to start systolic integration without breaking the verified NN inference flow and to measure the impact under both single issue and dual issue CPU modes.

## Inspiration and starting point
The work started from two observations.

1. The current accelerator had improving but still visible memory feed pressure and control overhead.
2. CPU dual issue gains were present but capped by accelerator side behavior.

This motivated an architecture that separates

1. a stable production path for correctness
2. an experimental systolic compute path for throughput scaling

The design strategy was to keep the verified path intact and make systolic selectable by compile flag so both paths can be measured under identical software and CPU conditions.

## Implementation summary
Code organization was split into legacy and systolic folders.

1. Legacy implementation preserved in `riscv-accelerator/legacy/MatmulAcceleratorLegacy.sv`
2. New systolic compute blocks added in `riscv-accelerator/systolic/`
   1. `SystolicPE.sv`
   2. `SystolicArray.sv`
   3. `MatmulAcceleratorSystolic.sv`
3. Top level accelerator wrapper updated in `riscv-accelerator/MatmulAccelerator.sv`
   1. default path is legacy
   2. systolic path is selected with `-DUSE_SYSTOLIC_ACCEL`

This preserves backward compatibility and enables controlled A B testing.

## Systolic architecture
### PE dataflow
```text
A west in  -> [ PE ] -> A east out
B north in -> [ PE ] -> B south out

Per cycle operation
acc_next = acc + A_in * B_in
```

### Array topology
```text
          B0        B1        B2        B3
           |         |         |         |
        +-----+   +-----+   +-----+   +-----+
A0 --->  |PE00|-->|PE01|-->|PE02|-->|PE03|
        +--|--+   +--|--+   +--|--+   +--|--+
           v         v         v         v
        +-----+   +-----+   +-----+   +-----+
A1 --->  |PE10|-->|PE11|-->|PE12|-->|PE13|
        +--|--+   +--|--+   +--|--+   +--|--+
           v         v         v         v
        +-----+   +-----+   +-----+   +-----+
A2 --->  |PE20|-->|PE21|-->|PE22|-->|PE23|
        +--|--+   +--|--+   +--|--+   +--|--+
           v         v         v         v
        +-----+   +-----+   +-----+   +-----+
A3 --->  |PE30|-->|PE31|-->|PE32|-->|PE33|
        +-----+   +-----+   +-----+   +-----+

Outputs Cij are the PE accumulators after the active window
```

## CPU DMA accelerator interaction
The system path under `riscv_top` remains MMIO driven from CPU software.

```text
CPU core with dual issue
  |
  | MMIO program and start
  v
MatmulAccelerator wrapper
  |\
  | \__ legacy path default
  |___ systolic path when USE_SYSTOLIC_ACCEL is set
  |
  | DMA request response interface
  v
Memory151 and no_cache_mem data source
```

Dual issue effect remains CPU side.

1. lane0 and lane1 retire independent instructions when hazards allow
2. accelerator commands are still issued through MMIO stores
3. improved accelerator behavior reduces CPU wait windows in polling phases

## Decision record
1. Preserve known good path first
   1. legacy accelerator retained with no behavior change as default
2. Add systolic path behind a flag
   1. `USE_SYSTOLIC_ACCEL` allows side by side benchmarking
3. Validate by full workload runs in SI and DI for both paths

## Verification commands
Legacy default

```bash
cd /Users/peter/riscv-nn-inference
make clean && make run ENABLE_DUAL_ISSUE=0
make clean && make run ENABLE_DUAL_ISSUE=1
```

Systolic selected

```bash
cd /Users/peter/riscv-nn-inference
make clean && make run ENABLE_DUAL_ISSUE=0 EXTRA_VFLAGS="-DUSE_SYSTOLIC_ACCEL"
make clean && make run ENABLE_DUAL_ISSUE=1 EXTRA_VFLAGS="-DUSE_SYSTOLIC_ACCEL"
```

All four runs completed with `*** PASSED ***`.

## Measured stats
### Legacy default path
1. SI
   1. cycles 1496975
   2. retired total 1341000
   3. IPC 0.895807
2. DI
   1. cycles 1343765
   2. retired total 1340633
   3. lane1 retired 154433
   4. IPC 0.997669

### Systolic selected path
1. SI
   1. cycles 1338227
   2. retired total 1221907
   3. IPC 0.913079
2. DI
   1. cycles 1184508
   2. retired total 1221907
   3. lane1 retired 154433
   4. IPC 1.031573

## Interpretation
1. The wrapper strategy achieved the main safety objective
   1. legacy remains runnable and stable
   2. systolic path is selectable without touching software workflow
2. DI remains beneficial in both paths with lane1 retirement active
3. The systolic path is now integrated at the system interface level and ready for the next phase of deeper datapath and DMA scheduling refinement

## Next steps
1. Replace placeholder systolic feed control with full DMA edge loader and skew scheduling
2. Add per phase counters inside systolic mode
   1. load cycles
   2. active MAC cycles
   3. drain cycles
3. Add fixed tile level golden checks for systolic mode against legacy mode under identical commands
