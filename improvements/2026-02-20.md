# Improvement Log 2026-02-20

## Scope
This note records dual issue and accelerator prefetch work completed on 2026-02-20.
The method was correctness first then throughput recovery using counter guided tuning.

## Implemented RTL changes
1. MatmulAccelerator moved to two slot block buffers `A_buf` and `B_buf` with `buf_valid` `use_idx` and `fill_idx`.
2. Fill control was split into `F_IDLE` `F_WAIT_A` and `F_WAIT_B` under one DMA read port.
3. Compute was switched to consume buffered blocks and hold state when no valid slot is available.
4. Startup prefill gating was added so first compute work does not underflow.
5. In `F_WAIT_B` the next A request now launches immediately when the next slot is free.
6. Assertion coverage was expanded for consume safety overwrite safety address sequence command boundaries and produced consumed equivalence.
7. Legacy load path states were removed from the active FSM after buffer consume behavior passed.
8. A delayed response timing variant using `dma_re_q` was tested and then reverted after measured regression.

## Strategy and decision record
1. One outstanding DMA transaction model was kept to match existing interface assumptions.
2. Runtime counters were used as the main decision signal.
3. The delayed response variant was rejected because stall time increased while correctness remained unchanged under the current memory model.
4. The higher throughput variant was kept and all verification tripwires stayed enabled.

## Measured results pre syn
Workload source was `make run` in `riscv-nn-inference`.

Single issue comparison
1. Delayed response variant  
   cycles 1902329  
   IPC 0.866904
2. Current variant  
   cycles 1583516  
   IPC 0.890383
3. Change  
   cycle reduction 318813  
   relative gain 16.76 percent

Dual issue comparison
1. Delayed response variant  
   cycles 1750511  
   IPC 0.942129
2. Current variant  
   cycles 1431792  
   IPC 0.984785
3. Change  
   cycle reduction 318719  
   relative gain 18.21 percent

Accelerator metric snapshot for `k_limit=196`
1. Delayed response variant  
   busy 789 compute 196 stall 588 fill 784 dma_req 392 occ_max 2  
   stall to busy ratio 74.52 percent
2. Current variant  
   busy 397 compute 196 stall 198 fill 392 dma_req 392 occ_max 2  
   stall to busy ratio 49.87 percent
3. Change  
   stall ratio reduced by 24.65 points

## Text plots
Total cycles lower is better
```text
Single issue delayed  1902329  ####################
Single issue current  1583516  ################
Dual issue delayed    1750511  ##################
Dual issue current    1431792  ###############
```

Accelerator stall ratio lower is better
```text
Delayed response path  74.52  ###################
Current path           49.87  #############
```

## PAR progress sky130
Run tag `par_mulonly_nomacro_pd62_20260219` is active.
The run has reached detailed routing in step 26.
Current detailed routing iterations reduced reported violations from 696 to 552 by iteration 29.
Iteration 30 has started and reached at least 40 percent in the latest routing log snapshot.
Observed peak memory in detailed routing log is 7638.95 MB.

Intermediate STA snapshots from the same run
1. Step 16 cts sta  
   worst setup slack 1.04  
   worst hold slack 0.17  
   tns 0  
   wns 0
2. Step 24 global route sta  
   worst setup slack 3.29  
   worst hold slack 0.19  
   tns 0  
   wns 0

## Next plan
1. Complete PAR and capture final `metrics.csv` with post route timing area and final violation counts.
2. Evaluate two outstanding DMA request tracking in the fill path to reduce remaining compute stalls.
3. Re run single issue and dual issue workload after any DMA queue change and compare against this baseline.
